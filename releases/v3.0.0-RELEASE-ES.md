# SYSGrow v3.0.0

**Fecha de lanzamiento:** 22 de febrero de 2026

Esta es una versión mayor. v3.0.0 incluye el pipeline completo de ML para riego inteligente, detección de anomalías en sensores, monitoreo de energía por actuador y una serie de mejoras arquitectónicas que hacen el backend más fácil de escalar y mantener. Muchas cosas que estaban diseñadas en sprints anteriores ahora están completamente conectadas y preparadas para producción.

---

## Novedades

### ML de Riego — Cuatro Modelos, Un Objetivo

La novedad central es un pipeline de ML completo para optimizar el riego. Aprende de cómo realmente usás el sistema y se va ajustando con el tiempo.

**Cuatro modelos entrenados, todos con métricas de calidad evaluadas antes de entrar a producción:**

| Modelo | Qué aprende | Umbral de aprobación |
|---|---|---|
| **Optimizador de Umbral** | Cuándo tus plantas realmente necesitan agua | MAE ≤ 4% o R² ≥ 0.55 |
| **Predictor de Respuesta** | Si vas a aprobar, posponer o cancelar una solicitud | Macro F1 ≥ 0.55, Balanced accuracy ≥ 0.55 |
| **Optimizador de Duración** | Cuánto tiempo tiene que correr la bomba | MAE ≤ 25ml, MAPE ≤ 40% |
| **Predictor de Timing** | Tus horarios preferidos de riego | Top-3 accuracy ≥ 0.60, MRR ≥ 0.55 |

Mientras un modelo no supere su umbral, el sistema sigue usando el enfoque bayesiano basado en reglas. Sin regresiones.

**Nuevos endpoints:**
```
GET  /api/v1/ml/irrigation/status           — Estado de los cuatro modelos
GET  /api/v1/ml/irrigation/predictions/<id> — Predicción para una unidad específica
POST /api/v1/ml/irrigation/feedback         — Registrar feedback del usuario (aprobar/posponer/cancelar)
GET  /api/v1/ml/irrigation/history/<id>     — Historial de feedback por unidad
```

### Reentrenamiento Automático

Los modelos se reentrenan solos según un calendario, sin intervención manual. La detección de drift dispara reentrenamientos fuera de horario cuando el rendimiento del modelo cae.

- Reentrenamiento semanal para los modelos de umbral, respuesta y timing
- Reentrenamiento mensual para el optimizador de duración
- Reentrenamiento por drift cuando el error supera los umbrales configurados
- Notificaciones de progreso en tiempo real vía Socket.IO
- **Nuevo:** Los trabajos que fallan 5 veces consecutivas se suspenden automáticamente y se registra el motivo — sin bucles de reintentos silenciosos

### Detección de Anomalías en Sensores

Cada lectura de sensor ahora se compara contra su baseline histórico. Las anomalías se persisten en la base de datos y se exponen a través de la API.

```
GET /api/v1/devices/sensors/<id>/anomalies  — Historial de anomalías de un sensor
GET /api/v1/devices/sensors/<id>/health     — Resumen de salud con indicador de anomalía
```

Cuando un sensor no puede leerse físicamente (sin hardware conectado), el sistema devuelve una lista vacía de anomalías en lugar de un error — que es el comportamiento correcto en un entorno de desarrollo.

### Monitoreo de Energía

Seguimiento del consumo eléctrico por actuador, por unidad, en el tiempo.

```
GET /api/v1/energy/units/<id>/summary          — Resumen de consumo
GET /api/v1/energy/units/<id>/history          — Datos históricos
GET /api/v1/energy/analytics/comparison        — Comparación entre unidades
GET /api/v1/energy/analytics/forecast          — Proyección de consumo
```

### Salud de Plantas con IA

El pipeline de salud de plantas está ahora completamente conectado de punta a punta:

- Monitoreo ambiental continuo con umbrales de alerta configurables
- Predicción de riesgo de enfermedades con clasificadores de gradient boosting
- Puntaje de salud con desglose por factor (temperatura, humedad, humedad del suelo, luz, CO₂)
- Recomendaciones de cuidado generadas por IA basadas en las condiciones actuales

### Aprendizaje Personalizado

El sistema construye un perfil de recomendaciones por usuario con el tiempo. Cuanto más interactuás, más relevantes se vuelven las sugerencias. Los perfiles se almacenan por unidad de cultivo y se pueden reiniciar.

```
GET  /api/v1/ml/personalized/profiles/<unit_id>            — Ver el perfil actual
GET  /api/v1/ml/personalized/recommendations/<unit_id>     — Obtener recomendaciones personalizadas
POST /api/v1/ml/personalized/profiles/<unit_id>/reset      — Reiniciar desde cero
```

---

## Estabilidad e Infraestructura

### Envelope de Respuesta Unificado

Todos los endpoints de la API ahora devuelven un envelope consistente `{ok, data, error}`:

```json
{
  "ok": true,
  "data": { ... },
  "error": null
}
```

Respuestas de error:
```json
{
  "ok": false,
  "data": null,
  "error": { "message": "...", "code": "..." }
}
```

El cliente frontend global (`apiRequest`) lo desenvuelve automáticamente, así que la mayoría de los call sites no lo ven.

### Registro de Modelos — Escritura Atómica

El archivo `registry.json` ahora se escribe de forma atómica (archivo temporal + rename). Un crash durante el guardado ya no deja el registro en estado corrupto.

### Limpieza Arquitectónica

- El enum `ActuatorType` unificado en una fuente canónica con hook `_missing_` para valores heredados
- Todo el SQL crudo removido de los controladores de blueprints — movido a `DatabaseMaintenanceService`
- El cálculo de uptime delegado a `SystemHealthService` (se eliminó la variable global `_SERVER_START_TIME`)
- La lógica de `determine_landing_page` movida a `GrowthService`
- El helper `log_if_available()` reduce el boilerplate en el activity logger
- Los ajustes estacionales ahora usan datos reales de horas de sol cuando `SunTimesService` está configurado, con una heurística mensual como fallback

---

## Cambios Incompatibles

- Ninguno en la API HTTP — todos los endpoints existentes siguen siendo compatibles hacia atrás.
- La variable `_SERVER_START_TIME` a nivel de módulo fue eliminada. Si tenés herramientas personalizadas que la leen directamente, usá `SystemHealthService.get_uptime()`.
- `get_default_camera_settings()` reemplaza a `get_camera_settings()`. El nombre viejo sigue como alias pero se va a remover en v4.

---

## Correcciones

- Rutas duplicadas `/api/plants/plants/` en el cliente frontend que causaban 404s en páginas de plantas
- `/api/ml/health` devolvía 500 por el envelope de respuesta faltante
- La página de detalle de plantas no cargaba porque el helper local chequeaba `res.success` contra una respuesta que usa `res.ok`
- Las páginas de analítica de energía chequeaban `response.ok` después de que `apiRequest` ya había desenvuelto el envelope
- El endpoint de anomalías de sensores devolvía 400 cuando el hardware del sensor no estaba conectado

---

## Próximos Pasos

- v3.1: Modelo CV para etapas de crecimiento (detección de etapa por imagen)
- v3.2: Coordinación de riego entre múltiples unidades
- A futuro: Integración con el asesor LLM (la base ya está en su lugar)

---

*¿Dudas o reportes? Abrí un ticket o revisá la documentación en `docs/ai_ml/`.*
