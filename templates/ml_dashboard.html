{% extends "base.html" %}
{% import "macros.html" as ui %}

{% block title %}ML Dashboard - SYSGrow{% endblock %}

{% block body_class %}ml-dashboard-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/kpi-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/alerts.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/ml_dashboard.css') }}">
{% endblock %}

{% block content %}
<div id="ml-dashboard-page" aria-labelledby="ml-dashboard-heading">
    
    {# ── Page Header ── #}
    {{ ui.page_header(
      title="ML Infrastructure Dashboard",
      icon="fas fa-robot",
      subtitle="Monitor and manage machine learning models, drift detection, and retraining jobs.",
      actions='
        <div class="d-flex align-items-center gap-4">
          <div class="d-flex align-items-center gap-2">
            <div class="health-dot healthy" id="health-indicator"></div>
            <span id="health-status" class="small text-muted fw-medium">Checking...</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <div class="ws-status-dot connected" id="websocket-status"></div>
            <span class="small text-muted fw-medium">Real-time</span>
          </div>
        </div>
      '
    ) }}

    {# ── Alert Container ── #}
    <div id="alert-container" class="mb-4"></div>

    {# ── KPI Summary Row (loaded eagerly) ── #}
    <div class="kpi-grid mb-4" id="kpi-row">
        {{ ui.kpi_card(id="kpi-models-active", label="Active Models", value="--", icon="fas fa-cube", variant="primary", value_id="kpi-models-value") }}
        {{ ui.kpi_card(id="kpi-overall-accuracy", label="Best Accuracy", value="--", icon="fas fa-bullseye", variant="success", value_id="kpi-accuracy-value") }}
        {{ ui.kpi_card(id="kpi-active-jobs", label="Retraining Jobs", value="--", icon="fas fa-cog", variant="info", value_id="kpi-jobs-value") }}
        {{ ui.kpi_card(id="kpi-system-health", label="System Health", value="--", icon="fas fa-heartbeat", variant="success", value_id="kpi-health-value") }}
    </div>

    {# ── Training Progress Card (shown dynamically) ── #}
    <div class="mb-4" id="training-progress-card" style="display:none;" role="status" aria-live="polite">
        {% call ui.content_card(title="Training in Progress", icon="fas fa-graduation-cap", variant="info") %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="mb-1" id="training-model-name">Model Name</h5>
                    <span class="badge bg-info-subtle text-info border border-info" id="training-stage">Preparing...</span>
                </div>
                {{ ui.ui_button("Cancel Training", id="btn-cancel-training", icon="fas fa-times", variant="outline-danger", size="sm") }}
            </div>
            <div class="progress mb-3" style="height: 1.5rem;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                     id="training-progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
            <div class="d-flex justify-content-between align-items-end">
                <p class="mb-0 text-muted small" id="training-status">Initializing training environment...</p>
                <div class="text-end">
                    <div class="text-muted small">
                        <span id="training-elapsed" class="me-2">Elapsed: 0s</span>
                        <span id="training-eta" class="fw-bold text-dark">ETA: --</span>
                    </div>
                </div>
            </div>
        {% endcall %}
    </div>

    {# ══════════════════════════════════════════════════════════════════════
       CORE PANELS (loaded eagerly — essential model management)
       ══════════════════════════════════════════════════════════════════════ #}
    <div class="row g-4 mb-4">

        {# ── Models Overview ── #}
        <div class="col-lg-6">
            {% call ui.content_card(
                title="Models Overview", 
                icon="fas fa-chart-pie",
                header_extra='<span class="badge bg-primary rounded-pill" id="models-count">0 Models</span>'
            ) %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="btn-group btn-group-sm" role="group" id="filter-models-group">
                        <button type="button" class="btn btn-outline-secondary active" data-filter="all">All</button>
                        <button type="button" class="btn btn-outline-secondary" data-filter="disease">Disease</button>
                        <button type="button" class="btn btn-outline-secondary" data-filter="climate">Climate</button>
                        <button type="button" class="btn btn-outline-secondary" data-filter="yield">Yield</button>
                    </div>
                </div>
                <div id="models-list-container" class="min-vh-25 overflow-auto mb-4" style="max-height: 400px;">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-box-open fa-3x mb-3 opacity-25"></i>
                        <p>No models registered yet</p>
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2 pt-3 border-top">
                    {{ ui.ui_button("Train New Model", id="btn-train-new-model", icon="fas fa-crosshairs", variant="primary", size="sm") }}
                    {{ ui.ui_button("Compare Models", id="btn-compare-models", icon="fas fa-chart-column", variant="outline-secondary", size="sm") }}
                    {{ ui.ui_button("Refresh", id="btn-refresh-models", icon="fas fa-sync-alt", variant="outline-secondary", size="sm") }}
                </div>
            {% endcall %}
        </div>

        {# ── Drift Monitoring ── #}
        <div class="col-lg-6">
            {% call ui.content_card(
                title="Drift Monitoring", 
                icon="fas fa-chart-line",
                header_extra='<span class="badge bg-success" id="drift-status">Healthy</span>'
            ) %}
                <div id="drift-metrics-container" class="mb-4">
                    <div class="metric-row">
                        <span class="metric-label">Prediction Accuracy</span>
                        <span class="metric-value" id="drift-accuracy">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Mean Confidence</span>
                        <div class="text-end">
                            <span class="badge bg-success-subtle text-success border border-success px-2 py-1" id="drift-confidence">--</span>
                            <div class="text-muted smallest mt-1" id="confidence-threshold">(threshold: 70%)</div>
                        </div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Error Rate</span>
                        <span class="metric-value text-danger" id="drift-error-rate">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Data Quality</span>
                        <div class="text-end">
                            <span class="badge bg-primary-subtle text-primary border border-primary px-2 py-1" id="data-quality">--</span>
                            <div class="text-muted smallest mt-1" id="training-samples">(-- samples)</div>
                        </div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">System Recommendation</span>
                        <span class="metric-value text-primary fs-7" id="drift-recommendation">--</span>
                    </div>
                    <div class="alert alert-warning mt-3 mb-0 d-none" id="drift-alert" role="alert">
                        <div class="d-flex align-items-start gap-3">
                            <i class="fas fa-exclamation-triangle mt-1"></i>
                            <div>
                                <h6 class="alert-heading fw-bold mb-1">Drift Detected!</h6>
                                <p class="small mb-2" id="drift-alert-message">Model accuracy dropped below threshold.</p>
                                {{ ui.ui_button("Trigger Retraining", id="btn-trigger-retraining", icon="fas fa-sync-alt", variant="warning", size="sm") }}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="pt-3 border-top">
                    {{ ui.ui_button("View Accuracy History", id="btn-view-drift-history", icon="fas fa-history", variant="outline-primary", size="sm", class="w-100") }}
                </div>
            {% endcall %}
        </div>

        {# ── Active Retraining Jobs (with embedded scheduler status) ── #}
        <div class="col-12">
            {% call ui.content_card(
                title="Retraining Jobs & Scheduler", 
                icon="fas fa-cog",
                header_extra='
                    <div class="d-flex align-items-center gap-3">
                        <span class="scheduler-badge stopped" id="scheduler-status">
                            <i class="fas fa-circle" style="font-size:0.5rem"></i> Checking...
                        </span>
                        <span class="badge bg-info-subtle text-info border border-info rounded-pill" id="jobs-count">0 Jobs</span>
                    </div>
                '
            ) %}
                <div class="d-flex flex-wrap gap-2 mb-3" id="scheduler-controls">
                    {{ ui.ui_button("Start Scheduler", id="btn-start-scheduler", icon="fas fa-play", variant="outline-success", size="sm") }}
                    {{ ui.ui_button("Stop Scheduler", id="btn-stop-scheduler", icon="fas fa-stop", variant="outline-danger", size="sm") }}
                </div>
                <div id="jobs-list-container">
                    <div class="text-center py-4 text-muted border border-dashed rounded bg-light-subtle">
                        <i class="far fa-calendar-alt fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0 small">No retraining jobs configured</p>
                    </div>
                </div>
            {% endcall %}
        </div>

        {# ── Model Performance Chart ── #}
        <div class="col-12">
            {% call ui.content_card(
                title="Model Performance Metrics Over Time", 
                icon="fas fa-chart-area",
                header_extra='
                    <div class="d-flex align-items-center gap-2">
                        <label for="drift-model-select" class="visually-hidden">Select Model</label>
                        <select id="drift-model-select" class="form-select form-select-sm" style="min-width: 200px;">
                            <option value="">Select Model to View</option>
                        </select>
                    </div>
                '
            ) %}
                <div class="chart-container-ml">
                    <canvas id="drift-chart"></canvas>
                </div>
            {% endcall %}
        </div>

        {# ── Training & Version History ── #}
        <div class="col-12">
            {% call ui.content_card(
                title="Training & Version History", 
                icon="fas fa-book",
                header_extra=ui.ui_button("Refresh History", id="btn-refresh-training-history", icon="fas fa-sync-alt", variant="link", size="sm", class="text-decoration-none p-0")
            ) %}
                <div id="training-history-container">
                    <div class="text-center py-4 text-muted border border-dashed rounded bg-light-subtle">
                        <i class="fas fa-history fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0 small">No training events recorded</p>
                    </div>
                </div>
            {% endcall %}
        </div>
    </div>

    {# ══════════════════════════════════════════════════════════════════════
       LAZY-LOADED PANELS (data fetched on expand to save Pi resources)
       ══════════════════════════════════════════════════════════════════════ #}
    <div class="row g-4 mb-4">

        {# ── Continuous Monitoring Insights ── #}
        <div class="col-12">
            <div class="card" id="section-continuous">
                <div class="card-header">
                    <button class="section-collapse-btn" 
                            aria-expanded="false" 
                            aria-controls="continuous-body"
                            data-section="continuous">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-satellite-dish"></i>
                            <h3 class="mb-0">Continuous Monitoring</h3>
                            <span class="badge bg-secondary-subtle text-secondary rounded-pill" id="continuous-status-badge">Not loaded</span>
                        </div>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </button>
                </div>
                <div class="section-body collapsed" id="continuous-body">
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {{ ui.ui_button("Start Monitoring", id="btn-start-monitoring", icon="fas fa-play", variant="outline-success", size="sm") }}
                            {{ ui.ui_button("Stop Monitoring", id="btn-stop-monitoring", icon="fas fa-stop", variant="outline-danger", size="sm") }}
                            {{ ui.ui_button("Refresh Insights", id="btn-refresh-insights", icon="fas fa-sync-alt", variant="outline-secondary", size="sm") }}
                        </div>
                        <div id="continuous-insights-container" class="insights-feed">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-satellite-dish fa-2x mb-2 opacity-25"></i>
                                <p class="mb-0 small">Expand to load monitoring insights</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ── Training Data Quality ── #}
        <div class="col-12">
            <div class="card" id="section-training-data">
                <div class="card-header">
                    <button class="section-collapse-btn" 
                            aria-expanded="false" 
                            aria-controls="training-data-body"
                            data-section="training-data">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-database"></i>
                            <h3 class="mb-0">Training Data Quality</h3>
                        </div>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </button>
                </div>
                <div class="section-body collapsed" id="training-data-body">
                    <div class="card-body">
                        <div id="training-data-container" class="data-quality-grid">
                            <div class="text-center py-4 text-muted" style="grid-column: 1/-1;">
                                <i class="fas fa-database fa-2x mb-2 opacity-25"></i>
                                <p class="mb-0 small">Expand to load training data quality metrics</p>
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-3 pt-3 border-top">
                            {{ ui.ui_button("Validate Data", id="btn-validate-data", icon="fas fa-check-circle", variant="outline-primary", size="sm") }}
                            {{ ui.ui_button("Refresh", id="btn-refresh-training-data", icon="fas fa-sync-alt", variant="outline-secondary", size="sm") }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ── Disease Trends ── #}
        <div class="col-12">
            <div class="card" id="section-disease-trends">
                <div class="card-header">
                    <button class="section-collapse-btn" 
                            aria-expanded="false" 
                            aria-controls="disease-trends-body"
                            data-section="disease-trends">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-virus"></i>
                            <h3 class="mb-0">Disease Trends</h3>
                        </div>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </button>
                </div>
                <div class="section-body collapsed" id="disease-trends-body">
                    <div class="card-body">
                        <div class="chart-container-ml" id="disease-trends-chart-container">
                            <canvas id="disease-trends-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ── Model Comparison (lazy via backend endpoint) ── #}
        <div class="col-12">
            <div class="card" id="section-model-comparison">
                <div class="card-header">
                    <button class="section-collapse-btn" 
                            aria-expanded="false" 
                            aria-controls="model-comparison-body"
                            data-section="model-comparison">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-chart-column"></i>
                            <h3 class="mb-0">Model Comparison</h3>
                        </div>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </button>
                </div>
                <div class="section-body collapsed" id="model-comparison-body">
                    <div class="card-body">
                        <div class="chart-container-ml" style="height: 400px;">
                            <canvas id="comparison-chart-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ── ML Readiness (irrigation model training progress) ── #}
        <div class="col-12">
            <div class="card" id="section-ml-readiness">
                <div class="card-header">
                    <button class="section-collapse-btn" 
                            aria-expanded="false" 
                            aria-controls="ml-readiness-body"
                            data-section="ml-readiness">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-tasks"></i>
                            <h3 class="mb-0">ML Readiness</h3>
                            <span class="badge bg-secondary-subtle text-secondary rounded-pill" id="readiness-status-badge">Not loaded</span>
                        </div>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </button>
                </div>
                <div class="section-body collapsed" id="ml-readiness-body">
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {{ ui.ui_button("Check All Units", id="btn-check-all-readiness", icon="fas fa-sync-alt", variant="outline-primary", size="sm") }}
                        </div>
                        <div id="readiness-models-container" class="readiness-grid">
                            <div class="text-center py-4 text-muted" style="grid-column:1/-1">
                                <i class="fas fa-tasks fa-2x mb-2 opacity-25"></i>
                                <p class="mb-0 small">Expand to check irrigation ML model readiness</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ── Irrigation ML Overview (pending requests + recommendations) ── #}
        <div class="col-12">
            <div class="card" id="section-irrigation-ml">
                <div class="card-header">
                    <button class="section-collapse-btn" 
                            aria-expanded="false" 
                            aria-controls="irrigation-ml-body"
                            data-section="irrigation-ml">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-tint"></i>
                            <h3 class="mb-0">Irrigation ML</h3>
                            <span class="badge bg-secondary-subtle text-secondary rounded-pill" id="irrigation-pending-badge">Not loaded</span>
                        </div>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </button>
                </div>
                <div class="section-body collapsed" id="irrigation-ml-body">
                    <div class="card-body">
                        <div id="irrigation-requests-container" class="mb-3">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-tint fa-2x mb-2 opacity-25"></i>
                                <p class="mb-0 small">Expand to view pending irrigation requests and ML config</p>
                            </div>
                        </div>
                        <div id="irrigation-config-container"></div>
                    </div>
                </div>
            </div>
        </div>

        {# ── A/B Testing (active tests + analysis) ── #}
        <div class="col-12">
            <div class="card" id="section-ab-testing">
                <div class="card-header">
                    <button class="section-collapse-btn" 
                            aria-expanded="false" 
                            aria-controls="ab-testing-body"
                            data-section="ab-testing">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-flask"></i>
                            <h3 class="mb-0">A/B Testing</h3>
                            <span class="badge bg-secondary-subtle text-secondary rounded-pill" id="ab-tests-count-badge">Not loaded</span>
                        </div>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </button>
                </div>
                <div class="section-body collapsed" id="ab-testing-body">
                    <div class="card-body">
                        <div id="ab-tests-container">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-flask fa-2x mb-2 opacity-25"></i>
                                <p class="mb-0 small">Expand to view A/B tests and analysis</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# ── Modal: Model Details ── #}
<div class="modal fade" id="model-details-modal" tabindex="-1" aria-labelledby="model-details-title" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="model-details-title">Model Specification & Metrics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="model-details-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{# ── Modal: Feature Importance ── #}
<div class="modal fade" id="features-modal" tabindex="-1" aria-labelledby="features-title" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="features-title">Explaining Model Decision Factors</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 overflow-auto">
                <div id="feature-importance-chart" class="chart-container-ml" style="height: 600px;"></div>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/api.js') }}?v=20260215b"></script>
<script src="{{ url_for('static', filename='js/ml/data-service.js') }}?v=20260215b"></script>
<script src="{{ url_for('static', filename='js/ml/ui-manager.js') }}?v=20260215b"></script>
<script src="{{ url_for('static', filename='js/ml/main.js') }}?v=20260215b"></script>
{% endblock %}
