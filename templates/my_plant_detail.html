{% extends "base.html" %}
{% import "macros.html" as ui %}

{% block title %}My Plant Detail - SYSGrow{% endblock %}
{% block body_class %}my-plant-detail-page{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/my-plant-detail.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/plants.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/timeline.css') }}">
{% endblock %}

{% block content %}
<div id="my-plant-detail" data-plant-id="{{ plant_id }}" aria-labelledby="plant-detail-heading">

  {# ===== Page Header (filled by JS) ===== #}
  <header class="page-header d-flex justify-content-between align-items-center mb-6">
    <div class="header-content">
      <h1 class="page-title h3 mb-1">
        <i class="fas fa-seedling me-2 text-brand-600"></i>
        <span id="plant-name-header">Loading…</span>
      </h1>
      <p class="text-muted mb-0 small" id="plant-subtitle-header"></p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('ui.plants_hub') }}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left"></i> Back to Plants
      </a>
    </div>
  </header>

  {# ===== KPI Row (filled by JS) ===== #}
  <div class="row g-4 mb-4" id="plant-kpi-row">
    <div class="col-md-6 col-lg-3">
      {{ ui.kpi_card(id="health", title="Health Status", icon="fas fa-heartbeat", variant="success", value_id="kpi-health-value") }}
    </div>
    <div class="col-md-6 col-lg-3">
      {{ ui.kpi_card(id="stage", title="Growth Stage", icon="fas fa-leaf", variant="info", value_id="kpi-stage-value") }}
    </div>
    <div class="col-md-6 col-lg-3">
      {{ ui.kpi_card(id="days", title="Days in Stage", icon="fas fa-calendar-day", variant="default", value_id="kpi-days-value") }}
    </div>
    <div class="col-md-6 col-lg-3">
      {{ ui.kpi_card(id="entries", title="Journal Entries", icon="fas fa-book", variant="default", value_id="kpi-entries-value") }}
    </div>
  </div>

  {# ===== Tabs ===== #}
  <nav class="plant-tabs mb-4" role="tablist" aria-label="Plant detail sections">
    <button class="tab-btn active" role="tab" data-tab="overview" aria-selected="true" aria-controls="tab-overview">
      <i class="fas fa-info-circle"></i> Overview
    </button>
    <button class="tab-btn" role="tab" data-tab="journal" aria-selected="false" aria-controls="tab-journal">
      <i class="fas fa-book-open"></i> Journal
    </button>
    <button class="tab-btn" role="tab" data-tab="analytics" aria-selected="false" aria-controls="tab-analytics">
      <i class="fas fa-chart-line"></i> Analytics
    </button>
    <button class="tab-btn" role="tab" data-tab="stage" aria-selected="false" aria-controls="tab-stage">
      <i class="fas fa-layer-group"></i> Stage
    </button>
  </nav>

  {# ===== Tab Panels ===== #}

  {# ---- Overview Tab ---- #}
  <section id="tab-overview" class="tab-panel active" role="tabpanel">
    <div class="row g-4">
      {# Plant Info Card #}
      <div class="col-lg-6">
        {% call ui.content_card(title="Plant Information", icon="fas fa-seedling", id="plant-info-card") %}
        <div id="plant-info-body" class="plant-info-grid">
          <p class="text-muted">Loading plant information…</p>
        </div>
        {% endcall %}
      </div>

      {# Linked Devices Card #}
      <div class="col-lg-6">
        {% call ui.content_card(title="Linked Devices", icon="fas fa-microchip", id="linked-devices-card") %}
        <div id="linked-devices-body">
          <p class="text-muted">Loading devices…</p>
        </div>
        {% endcall %}
      </div>

      {# Recent Journal Entries #}
      <div class="col-12">
        {% call ui.content_card(title="Recent Activity", icon="fas fa-clock", id="recent-entries-card") %}
        <div id="recent-entries-body">
          <p class="text-muted">Loading…</p>
        </div>
        {% endcall %}
      </div>
    </div>
  </section>

  {# ---- Journal Tab ---- #}
  <section id="tab-journal" class="tab-panel" role="tabpanel" hidden>
    {# Journal Controls #}
    <div class="journal-controls d-flex gap-3 mb-4 flex-wrap align-items-center">
      <select id="journal-type-filter" class="form-select form-select-sm" style="max-width: 200px;">
        <option value="">All Types</option>
        <option value="observation">Observation</option>
        <option value="watering">Watering</option>
        <option value="nutrient">Nutrient</option>
        <option value="treatment">Treatment</option>
        <option value="pruning">Pruning</option>
        <option value="stage_change">Stage Change</option>
        <option value="harvest">Harvest</option>
        <option value="transplant">Transplant</option>
        <option value="environmental_adjustment">Env. Adjustment</option>
        <option value="note">Note</option>
      </select>

      <button class="btn btn-primary btn-sm" id="btn-add-journal-entry">
        <i class="fas fa-plus"></i> Add Entry
      </button>
    </div>

    {# Journal Entries List #}
    {% call ui.content_card(title="Journal Entries", icon="fas fa-book-open", id="journal-entries-card") %}
    <div id="journal-entries-body">
      <p class="text-muted">Loading journal…</p>
    </div>

    {# Pagination #}
    <nav class="journal-pagination d-flex justify-content-center align-items-center gap-3 mt-4" id="journal-pagination" aria-label="Journal pagination">
    </nav>
    {% endcall %}

    {# Add Entry Modal #}
    <div class="modal-overlay" id="add-entry-modal" hidden>
      <div class="modal-dialog">
        <div class="modal-header">
          <h4><i class="fas fa-plus-circle"></i> Add Journal Entry</h4>
          <button class="modal-close" data-dismiss="modal" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="new-entry-type" class="form-label">Entry Type</label>
            <select id="new-entry-type" class="form-select">
              <option value="watering">Watering</option>
              <option value="observation">Observation</option>
              <option value="pruning">Pruning</option>
              <option value="nutrient">Nutrient</option>
              <option value="note">Note</option>
              <option value="transplant">Transplant</option>
              <option value="environmental_adjustment">Env. Adjustment</option>
            </select>
          </div>

          {# Dynamic form fields rendered by JS based on type #}
          <div id="entry-form-fields"></div>

          <div class="mb-3">
            <label for="new-entry-notes" class="form-label">Notes</label>
            <textarea id="new-entry-notes" class="form-control" rows="3" placeholder="Additional notes…"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-dismiss="modal">Cancel</button>
          <button class="btn btn-primary btn-sm" id="btn-save-entry">
            <i class="fas fa-save"></i> Save Entry
          </button>
        </div>
      </div>
    </div>
  </section>

  {# ---- Analytics Tab ---- #}
  <section id="tab-analytics" class="tab-panel" role="tabpanel" hidden>
    <div class="row g-4">
      <div class="col-lg-6">
        {% call ui.content_card(title="Watering History", icon="fas fa-tint", id="watering-chart-card") %}
        <canvas id="watering-chart" height="280"></canvas>
        {% endcall %}
      </div>
      <div class="col-lg-6">
        {% call ui.content_card(title="Health Trend", icon="fas fa-heartbeat", id="health-trend-card") %}
        <canvas id="health-trend-chart" height="280"></canvas>
        {% endcall %}
      </div>
      <div class="col-12">
        {% call ui.content_card(title="Journal Summary", icon="fas fa-chart-pie", id="journal-summary-card") %}
        <div id="journal-summary-body">
          <p class="text-muted">Loading summary…</p>
        </div>
        {% endcall %}
      </div>
    </div>
  </section>

  {# ---- Stage Tab ---- #}
  <section id="tab-stage" class="tab-panel" role="tabpanel" hidden>
    <div class="row g-4">
      {# Stage Info #}
      <div class="col-lg-6">
        {% call ui.content_card(title="Current Stage", icon="fas fa-layer-group", id="stage-info-card") %}
        <div id="stage-info-body">
          <p class="text-muted">Loading stage info…</p>
        </div>
        {% endcall %}
      </div>

      {# Stage Extension #}
      <div class="col-lg-6">
        {% call ui.content_card(title="Extend Stage", icon="fas fa-clock", id="stage-extend-card") %}
        <form id="stage-extend-form" class="stage-extend-form">
          <div class="mb-3">
            <label for="extend-days" class="form-label">Days to Extend (max 5)</label>
            <input type="number" id="extend-days" class="form-control" min="1" max="5" value="1">
          </div>
          <div class="mb-3">
            <label for="extend-reason" class="form-label">Reason (optional)</label>
            <input type="text" id="extend-reason" class="form-control" placeholder="Why extend?">
          </div>
          {{ ui.ui_button("Extend Stage", type="submit", variant="primary", icon="fas fa-clock", size="sm") }}
        </form>
        <div id="extend-result" class="mt-3" hidden></div>
        {% endcall %}
      </div>

      {# Stage Timeline #}
      <div class="col-12">
        {% call ui.content_card(title="Stage Timeline", icon="fas fa-stream", id="stage-timeline-card") %}
        <div id="stage-timeline-body">
          <p class="text-muted">Loading timeline…</p>
        </div>
        {% endcall %}
      </div>
    </div>
  </section>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/my-plant-detail.js') }}"></script>
{% endblock %}
