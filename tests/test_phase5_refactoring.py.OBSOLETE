#!/usr/bin/env python3
"""
Test script for Phase 5: Analytics Service Consolidation

Tests the refactored architecture where:
- DeviceService focuses on CRUD operations
- AnalyticsService handles all analytics (sensors + actuators)
- DeviceService delegates analytics calls to AnalyticsService
- New predictive analytics features work correctly
"""

import sys
from datetime import datetime, timedelta
from typing import Dict, List, Any

# Test results tracking
test_results = {
    'passed': 0,
    'failed': 0,
    'errors': []
}

def log_test(test_name: str, passed: bool, message: str = ""):
    """Log test result."""
    status = "‚úÖ PASS" if passed else "‚ùå FAIL"
    print(f"{status}: {test_name}")
    if message:
        print(f"  ‚Üí {message}")
    
    if passed:
        test_results['passed'] += 1
    else:
        test_results['failed'] += 1
        test_results['errors'].append(f"{test_name}: {message}")
    print()

def test_imports():
    """Test 1: Verify all imports work correctly."""
    print("=" * 70)
    print("TEST 1: Import Validation")
    print("=" * 70)
    
    try:
        from app.services.analytics_service import AnalyticsService
        log_test("Import AnalyticsService", True)
    except Exception as e:
        log_test("Import AnalyticsService", False, str(e))
        return False
    
    try:
        from app.services.device_service import DeviceService
        log_test("Import DeviceService", True)
    except Exception as e:
        log_test("Import DeviceService", False, str(e))
        return False
    
    try:
        from app.services.container import ServiceContainer
        log_test("Import ServiceContainer", True)
    except Exception as e:
        log_test("Import ServiceContainer", False, str(e))
        return False
    
    return True

def test_analytics_service_initialization():
    """Test 2: Verify AnalyticsService can be initialized with DeviceRepository."""
    print("=" * 70)
    print("TEST 2: AnalyticsService Initialization")
    print("=" * 70)
    
    try:
        from app.services.analytics_service import AnalyticsService
        from app.repositories.analytics_repository import AnalyticsRepository
        from app.repositories.device_repository import DeviceRepository
        
        # Mock repositories
        class MockAnalyticsRepo:
            pass
        
        class MockDeviceRepo:
            pass
        
        # Test initialization with both repositories
        analytics_service = AnalyticsService(
            analytics_repository=MockAnalyticsRepo(),
            device_repository=MockDeviceRepo()
        )
        
        has_device_repo = hasattr(analytics_service, 'device_repository')
        log_test("AnalyticsService has device_repository", has_device_repo)
        
        has_electricity_rate = hasattr(analytics_service, 'electricity_rate')
        log_test("AnalyticsService has electricity_rate", has_electricity_rate)
        
        return has_device_repo and has_electricity_rate
        
    except Exception as e:
        log_test("AnalyticsService initialization", False, str(e))
        return False

def test_analytics_service_methods():
    """Test 3: Verify AnalyticsService has all required methods."""
    print("=" * 70)
    print("TEST 3: AnalyticsService Method Availability")
    print("=" * 70)
    
    try:
        from app.services.analytics_service import AnalyticsService
        
        required_methods = [
            # Sensor analytics (existing)
            'get_latest_sensor_reading',
            'get_latest_energy_reading',
            'fetch_sensor_history',
            'get_sensor_statistics',
            # Actuator analytics (Phase 5)
            'get_actuator_energy_cost_trends',
            'get_actuator_optimization_recommendations',
            'detect_actuator_power_anomalies',
            'get_comparative_energy_analysis',
            'get_actuator_energy_dashboard',
            # Predictive analytics (Phase 5 - NEW)
            'predict_device_failure',
        ]
        
        all_exist = True
        for method_name in required_methods:
            exists = hasattr(AnalyticsService, method_name)
            log_test(f"Method: {method_name}", exists)
            if not exists:
                all_exist = False
        
        return all_exist
        
    except Exception as e:
        log_test("AnalyticsService method check", False, str(e))
        return False

def test_device_service_initialization():
    """Test 4: Verify DeviceService can be initialized with AnalyticsService."""
    print("=" * 70)
    print("TEST 4: DeviceService Initialization")
    print("=" * 70)
    
    try:
        from app.services.device_service import DeviceService
        
        class MockRepository:
            pass
        
        class MockGrowthService:
            pass
        
        class MockAnalyticsService:
            pass
        
        # Test initialization with analytics_service parameter
        device_service = DeviceService(
            repository=MockRepository(),
            growth_service=MockGrowthService(),
            analytics_service=MockAnalyticsService()
        )
        
        has_analytics_service = hasattr(device_service, 'analytics_service')
        log_test("DeviceService has analytics_service", has_analytics_service)
        
        is_not_none = device_service.analytics_service is not None
        log_test("DeviceService analytics_service is set", is_not_none)
        
        return has_analytics_service and is_not_none
        
    except Exception as e:
        log_test("DeviceService initialization", False, str(e))
        return False

def test_device_service_delegation():
    """Test 5: Verify DeviceService delegates analytics calls."""
    print("=" * 70)
    print("TEST 5: DeviceService Delegation Pattern")
    print("=" * 70)
    
    try:
        from app.services.device_service import DeviceService
        
        class MockAnalyticsService:
            def __init__(self):
                self.called_methods = []
            
            def get_actuator_energy_cost_trends(self, actuator_id, days):
                self.called_methods.append('get_actuator_energy_cost_trends')
                return {
                    'actuator_id': actuator_id,
                    'period_days': days,
                    'daily_costs': [],
                    'total_cost': 0.0
                }
            
            def get_actuator_optimization_recommendations(self, actuator_id):
                self.called_methods.append('get_actuator_optimization_recommendations')
                return []
            
            def detect_actuator_power_anomalies(self, actuator_id, hours):
                self.called_methods.append('detect_actuator_power_anomalies')
                return []
            
            def get_comparative_energy_analysis(self, unit_id):
                self.called_methods.append('get_comparative_energy_analysis')
                return {'summary': {}}
        
        mock_analytics = MockAnalyticsService()
        device_service = DeviceService(
            repository=None,
            analytics_service=mock_analytics
        )
        
        # Test delegation for cost trends
        result = device_service.get_energy_cost_trends(123, days=7)
        delegated_cost_trends = 'get_actuator_energy_cost_trends' in mock_analytics.called_methods
        log_test("Delegates get_energy_cost_trends", delegated_cost_trends)
        
        # Test delegation for recommendations
        result = device_service.get_energy_optimization_recommendations(123)
        delegated_recommendations = 'get_actuator_optimization_recommendations' in mock_analytics.called_methods
        log_test("Delegates get_energy_optimization_recommendations", delegated_recommendations)
        
        # Test delegation for anomalies
        result = device_service.detect_power_anomalies(123, hours=24)
        delegated_anomalies = 'detect_actuator_power_anomalies' in mock_analytics.called_methods
        log_test("Delegates detect_power_anomalies", delegated_anomalies)
        
        # Test delegation for comparative analysis
        result = device_service.get_comparative_energy_analysis(unit_id=5)
        delegated_comparative = 'get_comparative_energy_analysis' in mock_analytics.called_methods
        log_test("Delegates get_comparative_energy_analysis", delegated_comparative)
        
        return (delegated_cost_trends and delegated_recommendations and 
                delegated_anomalies and delegated_comparative)
        
    except Exception as e:
        log_test("DeviceService delegation", False, str(e))
        return False

def test_device_service_fallback():
    """Test 6: Verify DeviceService handles missing AnalyticsService gracefully."""
    print("=" * 70)
    print("TEST 6: DeviceService Fallback (No AnalyticsService)")
    print("=" * 70)
    
    try:
        from app.services.device_service import DeviceService
        
        # Initialize without analytics_service
        device_service = DeviceService(repository=None)
        
        # Test that methods return error messages instead of crashing
        result = device_service.get_energy_cost_trends(123, days=7)
        has_error = 'error' in result
        log_test("Returns error when AnalyticsService missing", has_error)
        
        result = device_service.get_energy_optimization_recommendations(123)
        is_list = isinstance(result, list)
        log_test("Returns list for recommendations fallback", is_list)
        
        result = device_service.detect_power_anomalies(123)
        is_empty_list = isinstance(result, list) and len(result) == 0
        log_test("Returns empty list for anomalies fallback", is_empty_list)
        
        return has_error and is_list and is_empty_list
        
    except Exception as e:
        log_test("DeviceService fallback", False, str(e))
        return False

def test_service_container():
    """Test 7: Verify ServiceContainer initializes services correctly."""
    print("=" * 70)
    print("TEST 7: ServiceContainer Initialization")
    print("=" * 70)
    
    try:
        from app.services.container import ServiceContainer
        from database.connection import DatabaseConnection
        
        # Create a mock database connection
        class MockDB:
            pass
        
        container = ServiceContainer(MockDB())
        
        # Test that container has all services
        has_analytics_repo = hasattr(container, 'analytics_repository')
        log_test("Container has analytics_repository", has_analytics_repo)
        
        has_device_repo = hasattr(container, 'device_repository')
        log_test("Container has device_repository", has_device_repo)
        
        has_analytics_service = hasattr(container, 'analytics_service')
        log_test("Container has analytics_service", has_analytics_service)
        
        has_device_service = hasattr(container, 'device_service')
        log_test("Container has device_service", has_device_service)
        
        # Test that analytics_service has device_repository
        if has_analytics_service:
            analytics_has_device_repo = hasattr(container.analytics_service, 'device_repository')
            log_test("AnalyticsService has device_repository injected", analytics_has_device_repo)
        else:
            analytics_has_device_repo = False
        
        # Test that device_service has analytics_service
        if has_device_service:
            device_has_analytics = hasattr(container.device_service, 'analytics_service')
            log_test("DeviceService has analytics_service injected", device_has_analytics)
        else:
            device_has_analytics = False
        
        return (has_analytics_repo and has_device_repo and has_analytics_service and 
                has_device_service and analytics_has_device_repo and device_has_analytics)
        
    except Exception as e:
        log_test("ServiceContainer initialization", False, str(e))
        return False

def test_api_blueprints():
    """Test 8: Verify API blueprints import correctly."""
    print("=" * 70)
    print("TEST 8: API Blueprint Validation")
    print("=" * 70)
    
    try:
        from app.blueprints.api.devices import devices_bp
        log_test("Import devices blueprint", True)
    except Exception as e:
        log_test("Import devices blueprint", False, str(e))
        return False
    
    try:
        from app.blueprints.api.insights import insights_bp
        log_test("Import insights blueprint", True)
    except Exception as e:
        log_test("Import insights blueprint", False, str(e))
        return False
    
    return True

def test_predictive_analytics_structure():
    """Test 9: Verify predictive analytics method structure."""
    print("=" * 70)
    print("TEST 9: Predictive Analytics Structure")
    print("=" * 70)
    
    try:
        from app.services.analytics_service import AnalyticsService
        import inspect
        
        # Check predict_device_failure signature
        sig = inspect.signature(AnalyticsService.predict_device_failure)
        params = list(sig.parameters.keys())
        
        has_self = 'self' in params
        has_actuator_id = 'actuator_id' in params
        has_days_ahead = 'days_ahead' in params
        
        log_test("predict_device_failure has 'actuator_id' param", has_actuator_id)
        log_test("predict_device_failure has 'days_ahead' param", has_days_ahead)
        
        # Check for helper method
        has_helper = hasattr(AnalyticsService, '_get_maintenance_recommendation')
        log_test("Has _get_maintenance_recommendation helper", has_helper)
        
        return has_actuator_id and has_days_ahead and has_helper
        
    except Exception as e:
        log_test("Predictive analytics structure", False, str(e))
        return False

def print_summary():
    """Print test summary."""
    print("\n" + "=" * 70)
    print("TEST SUMMARY")
    print("=" * 70)
    print(f"‚úÖ Passed: {test_results['passed']}")
    print(f"‚ùå Failed: {test_results['failed']}")
    print(f"üìä Total: {test_results['passed'] + test_results['failed']}")
    
    success_rate = (test_results['passed'] / (test_results['passed'] + test_results['failed']) * 100) if (test_results['passed'] + test_results['failed']) > 0 else 0
    print(f"üéØ Success Rate: {success_rate:.1f}%")
    
    if test_results['failed'] > 0:
        print("\n‚ùå FAILED TESTS:")
        for error in test_results['errors']:
            print(f"  - {error}")
    
    print("=" * 70)
    
    return test_results['failed'] == 0

def main():
    """Run all tests."""
    print("\n" + "üß™" * 35)
    print("Phase 5: Analytics Service Consolidation - Test Suite")
    print("üß™" * 35 + "\n")
    
    # Run all tests
    tests = [
        test_imports,
        test_analytics_service_initialization,
        test_analytics_service_methods,
        test_device_service_initialization,
        test_device_service_delegation,
        test_device_service_fallback,
        test_service_container,
        test_api_blueprints,
        test_predictive_analytics_structure,
    ]
    
    for test_func in tests:
        try:
            test_func()
        except Exception as e:
            print(f"‚ùå CRITICAL ERROR in {test_func.__name__}: {e}")
            test_results['failed'] += 1
            test_results['errors'].append(f"{test_func.__name__}: CRITICAL - {e}")
    
    # Print summary
    all_passed = print_summary()
    
    if all_passed:
        print("\n‚úÖ Phase 5 refactoring validation: SUCCESS")
        print("   All architectural changes are working correctly!")
        return 0
    else:
        print("\n‚ùå Phase 5 refactoring validation: FAILED")
        print("   Some tests failed. Please review the errors above.")
        return 1

if __name__ == '__main__':
    sys.exit(main())
